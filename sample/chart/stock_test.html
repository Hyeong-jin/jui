<!DOCTYPE html>
<html>
<head>
    <meta chartset="utf-8" />
    <link rel="stylesheet" href="../../jui.css" />
    <link rel="stylesheet" href="../../lib/animate.min.css" />
    <script src="../../lib/jquery-1.8.3.min.js"></script>
    <script src="../../jui.js"></script>
</head>
<body class="jui">

<div class="row" style="margin-bottom: 7px;">
    <div class="col col-6">
        <div class="group">
            <a href="javascript:toggleDatepicker(0, this);" class="btn btn-gray btn-small"><i class="icon-calendar"></i></a>
            <input id="start_date" class="input input-small" />
        </div>
        &nbsp;~
        <div class="group">
            <a href="javascript:toggleDatepicker(1, this);" class="btn btn-gray btn-small"><i class="icon-calendar"></i></a>
            <input id="end_date" class="input input-small" />
        </div>
    </div>
    <div class="col col-6" style="text-align: right;">
        <input type="file" id="xtable_btn">
    </div>
</div>

<div class="row" style="margin-bottom: 14px;">
    <table id="xtable" class="table table-classic">
        <thead>
        <tr>
            <th>Date</th>
            <th>Open</th>
            <th>High</th>
            <th>Low</th>
            <th>Close</th>
            <th>Volume</th>
            <th>Adj Close</th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<div class="row">
    <div id="chart"></div>
</div>

<div class="datepicker">
    <div class="head">
        <div class="prev"></div>
        <div class="title"></div>
        <div class="next"></div>
    </div>
    <table class="body">
        <tr>
            <th>S</th><th>M</th><th>T</th><th>W</th><th>T</th><th>F</th><th>S</th>
        </tr>
    </table>
</div>

<div class="datepicker">
    <div class="head">
        <div class="prev"></div>
        <div class="title"></div>
        <div class="next"></div>
    </div>
    <table class="body">
        <tr>
            <th>S</th><th>M</th><th>T</th><th>W</th><th>T</th><th>F</th><th>S</th>
        </tr>
    </table>
</div>

<script id="tpl_dates" type="text/template">
    <tr>
        <! for(var i = 0; i < dates.length; i++) { !>
        <td><!= dates[i] !></td>
        <! } !>
    </tr>
</script>


<script data-jui="#xtable" data-tpl="row" type="text/template">
    <tr>
        <td><!= date !></td>
        <td><!= open !></td>
        <td><!= high !></td>
        <td><!= low !></td>
        <td><!= close !></td>
        <td><!= volume !></td>
        <td><!= adj_close !></td>
    </tr>
</script>

<script>
    var dates = null, xtable = null;

    jui.ready([ "chart.basic", "uix.xtable", "ui.datepicker" ], function(chart, table, datepicker) {
        dates = datepicker(".datepicker", {
            titleFormat: "yyyy. MM.",
            format: "yyyy-MM-dd",
            date: "2010-01-01",
            event: {
                select: function(date, e) {
                    $(".input").eq(this.index).val(date);
                    $(".datepicker").hide();

                    filterTable();
                }
            },
            tpl: {
                dates: $("#tpl_dates").html()
            }
        });

        xtable = table("#xtable", {
            fields: [ "date", "open", "high", "low", "close", "volume", "adj_close" ],
            sort: true,
            resize: true,
            animate: true
        });

        $("#xtable_btn").change(function(e) {
            xtable.setCsvFile(e.target.files[0]);
        });

        chart("#chart", {
            width: 1000,
            height : 500,
            theme : location.href.split("?")[1].split("=")[1],
            grid : {
                x : {
                    type : "block",  // default type is block
                    target : 'date',
                    reverse : true, 
                    format: function(d) {
                        
                        var arr = d.split("-");
                        
                        var day = arr[2];
                        var year = arr[0];
                        var month = arr[1];

                        if ((day == '01' || day == '02' || day == '03' || day == '04') && month == '01' && parseInt(year) % 2 == 0) {
                            return year;    
                        } else {
                            return "";
                        }
                    }
                },
                y : {
                    type : 'range',
                    target: [ "open", "high", "low", "close" ],
                    step: 5,
                    line : true
                }
            },
            series : {
                low: {
                    type: "low"
                },
                high: {
                    type: "high"
                },
                open: {
                    type: "open"
                },
                close: {
                    type: "close"
                }
            },
            brush : {
                type : 'candlestick'
            },
            bind: xtable
        });
	});

    function toggleDatepicker(index) {
        var offset = {
            left: (index == 0) ? 8 : 227,
            top: 34
        },
        $root = $(dates[index].root);

        $root.css({
            left: offset.left,
            top: offset.top
        });

        $(".datepicker").hide();

        if($root.css("display") == "block") {
            $root.hide();
        } else {
            $root.show();
        }
    }

    function filterTable() {
        var sdate = $(".input").eq(0).val(),
            edate = $(".input").eq(1).val();

        if(sdate != "" && edate != "") {
            var stime = new Date(sdate).getTime(),
                etime = new Date(edate).getTime();

            xtable.filter(function(row) {
                var time = new Date(row.date).getTime();

                if(time >= stime && time <= etime) {
                    return true;
                }
            });
        }
    }
</script>

<style>
    .row {
        width: 1000px;
    }

    .datepicker {
        display: none;
        position: absolute;
    }

    .input {
        width: 158px;
    }
</style>

</body>
</html>